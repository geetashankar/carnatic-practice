<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Svara ‚Äî Carnatic Practice Companion</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=EB+Garamond:ital,wght@0,400;0,500;1,400&family=Noto+Serif+Devanagari:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0d0a07;
    --bg2: #15100a;
    --surface: #1e1510;
    --surface2: #2a1e14;
    --gold: #c9943a;
    --gold-light: #e8b85a;
    --gold-dim: #7a5a22;
    --amber: #e07020;
    --red: #c03a2a;
    --cream: #f0e8d5;
    --cream-dim: #a09070;
    --border: rgba(201,148,58,0.25);
    --border-bright: rgba(201,148,58,0.6);
    --font-display: 'Cinzel Decorative', serif;
    --font-body: 'EB Garamond', serif;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--cream);
    font-family: var(--font-body);
    font-size: 18px;
    line-height: 1.6;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* BACKGROUND TEXTURE */
  body::before {
    content: '';
    position: fixed; inset: 0;
    background:
      radial-gradient(ellipse 80% 60% at 50% -10%, rgba(201,148,58,0.12) 0%, transparent 70%),
      radial-gradient(ellipse 40% 40% at 10% 90%, rgba(192,58,42,0.08) 0%, transparent 60%),
      repeating-linear-gradient(0deg, transparent, transparent 60px, rgba(201,148,58,0.02) 60px, rgba(201,148,58,0.02) 61px),
      repeating-linear-gradient(90deg, transparent, transparent 60px, rgba(201,148,58,0.02) 60px, rgba(201,148,58,0.02) 61px);
    pointer-events: none;
    z-index: 0;
  }

  /* ORNAMENTAL BORDER */
  body::after {
    content: '';
    position: fixed; inset: 12px;
    border: 1px solid var(--border);
    pointer-events: none;
    z-index: 100;
  }

  /* HEADER */
  header {
    position: relative; z-index: 1;
    text-align: center;
    padding: 56px 24px 40px;
    border-bottom: 1px solid var(--border);
  }

  .header-ornament {
    color: var(--gold-dim);
    font-size: 13px;
    letter-spacing: 8px;
    text-transform: uppercase;
    margin-bottom: 12px;
    display: flex; align-items: center; justify-content: center; gap: 16px;
  }
  .header-ornament::before, .header-ornament::after {
    content: '‚ú¶';
    color: var(--gold);
  }

  h1 {
    font-family: var(--font-display);
    font-size: clamp(28px, 5vw, 52px);
    color: var(--gold-light);
    letter-spacing: 4px;
    text-shadow: 0 0 60px rgba(201,148,58,0.4);
    margin-bottom: 8px;
  }

  .subtitle {
    font-style: italic;
    color: var(--cream-dim);
    font-size: 17px;
    letter-spacing: 1px;
  }

  /* NAV TABS */
  nav {
    position: relative; z-index: 1;
    display: flex;
    justify-content: center;
    gap: 0;
    padding: 0 24px;
    border-bottom: 1px solid var(--border);
    background: rgba(21,16,10,0.7);
    flex-wrap: wrap;
  }

  nav button {
    background: none; border: none; cursor: pointer;
    font-family: var(--font-body);
    font-size: 15px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--cream-dim);
    padding: 20px 28px;
    position: relative;
    transition: color 0.3s;
  }
  nav button:hover { color: var(--gold-light); }
  nav button.active {
    color: var(--gold-light);
  }
  nav button.active::after {
    content: '';
    position: absolute; bottom: 0; left: 20%; right: 20%;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--gold), transparent);
  }

  /* MAIN CONTENT */
  main {
    position: relative; z-index: 1;
    max-width: 900px;
    margin: 0 auto;
    padding: 40px 24px 80px;
  }

  .tab-panel { display: none; }
  .tab-panel.active { display: block; animation: fadeIn 0.4s ease; }

  @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

  /* CARD */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 2px;
    padding: 32px;
    margin-bottom: 24px;
    position: relative;
    overflow: hidden;
  }
  .card::before {
    content: '';
    position: absolute; top: 0; left: 0; right: 0; height: 1px;
    background: linear-gradient(90deg, transparent, var(--gold-dim), transparent);
  }

  .card-title {
    font-family: var(--font-display);
    font-size: 14px;
    color: var(--gold);
    letter-spacing: 3px;
    text-transform: uppercase;
    margin-bottom: 20px;
    display: flex; align-items: center; gap: 12px;
  }
  .card-title::after {
    content: '';
    flex: 1;
    height: 1px;
    background: linear-gradient(90deg, var(--border), transparent);
  }

  /* BUTTONS */
  .btn {
    background: none;
    border: 1px solid var(--gold-dim);
    color: var(--gold-light);
    font-family: var(--font-body);
    font-size: 15px;
    letter-spacing: 2px;
    text-transform: uppercase;
    padding: 12px 28px;
    cursor: pointer;
    transition: all 0.25s;
    position: relative;
    overflow: hidden;
  }
  .btn:hover {
    border-color: var(--gold);
    background: rgba(201,148,58,0.1);
    box-shadow: 0 0 20px rgba(201,148,58,0.15);
  }
  .btn.primary {
    background: linear-gradient(135deg, rgba(201,148,58,0.2), rgba(201,148,58,0.05));
    border-color: var(--gold);
  }
  .btn.danger { border-color: var(--red); color: #e06050; }
  .btn.danger:hover { background: rgba(192,58,42,0.1); }

  /* SHRUTI / TANPURA */
  .shruti-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(52px, 1fr));
    gap: 8px;
    margin: 20px 0;
  }

  .shruti-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--cream-dim);
    font-family: var(--font-body);
    font-size: 15px;
    padding: 12px 8px;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
    border-radius: 1px;
  }
  .shruti-btn:hover { border-color: var(--gold); color: var(--gold-light); }
  .shruti-btn.selected {
    background: rgba(201,148,58,0.15);
    border-color: var(--gold);
    color: var(--gold-light);
    box-shadow: 0 0 12px rgba(201,148,58,0.2) inset;
  }

  .tanpura-visual {
    display: flex;
    align-items: flex-end;
    justify-content: center;
    gap: 12px;
    height: 120px;
    margin: 20px 0;
  }

  .string-wrap {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    flex: 1;
    max-width: 70px;
  }

  .string {
    width: 3px;
    background: linear-gradient(180deg, var(--gold-dim), var(--amber));
    border-radius: 2px;
    transition: height 0.5s ease, box-shadow 0.5s ease;
    cursor: pointer;
    position: relative;
  }
  .string.playing {
    box-shadow: 0 0 8px 2px rgba(224,112,32,0.6);
    animation: pluck 0.6s ease-out;
  }
  @keyframes pluck {
    0% { transform: scaleX(1); }
    20% { transform: scaleX(4); }
    100% { transform: scaleX(1); }
  }

  .string-label {
    font-size: 13px;
    color: var(--cream-dim);
    text-align: center;
    letter-spacing: 1px;
  }

  .tempo-control {
    display: flex;
    align-items: center;
    gap: 16px;
    flex-wrap: wrap;
  }

  .tempo-display {
    font-family: var(--font-display);
    font-size: 48px;
    color: var(--gold-light);
    text-shadow: 0 0 30px rgba(201,148,58,0.5);
    min-width: 120px;
    text-align: center;
  }

  .tempo-unit {
    font-size: 13px;
    color: var(--cream-dim);
    letter-spacing: 2px;
    text-transform: uppercase;
  }

  input[type=range] {
    -webkit-appearance: none;
    width: 100%;
    height: 3px;
    background: linear-gradient(90deg, var(--gold), var(--surface2));
    border-radius: 2px;
    outline: none;
    margin: 12px 0;
    cursor: pointer;
  }
  input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 18px; height: 18px;
    background: var(--gold);
    border-radius: 50%;
    box-shadow: 0 0 8px rgba(201,148,58,0.5);
  }

  /* TIMER */
  .timer-display {
    font-family: var(--font-display);
    font-size: 72px;
    text-align: center;
    color: var(--gold-light);
    text-shadow: 0 0 40px rgba(201,148,58,0.5);
    letter-spacing: 4px;
    padding: 20px 0;
    line-height: 1;
  }

  .timer-progress {
    height: 3px;
    background: var(--surface2);
    border-radius: 2px;
    margin: 16px 0;
    overflow: hidden;
  }
  .timer-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--red), var(--amber), var(--gold));
    border-radius: 2px;
    transition: width 1s linear;
    width: 0%;
  }

  .varisai-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 10px;
    margin-bottom: 20px;
  }

  .varisai-item {
    background: var(--surface2);
    border: 1px solid var(--border);
    padding: 14px 16px;
    cursor: pointer;
    transition: all 0.2s;
    border-radius: 1px;
  }
  .varisai-item:hover { border-color: var(--gold); }
  .varisai-item.selected {
    background: rgba(201,148,58,0.1);
    border-color: var(--gold);
  }
  .varisai-name {
    font-size: 15px;
    color: var(--cream);
    margin-bottom: 4px;
  }
  .varisai-pattern {
    font-size: 12px;
    color: var(--cream-dim);
    font-family: monospace;
    letter-spacing: 1px;
  }

  /* LEADERBOARD */
  .leaderboard-form {
    display: flex;
    gap: 12px;
    margin-bottom: 24px;
    flex-wrap: wrap;
    align-items: flex-end;
  }

  .field {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .field label {
    font-size: 12px;
    color: var(--cream-dim);
    letter-spacing: 2px;
    text-transform: uppercase;
  }
  .field input, .field select {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--cream);
    font-family: var(--font-body);
    font-size: 16px;
    padding: 10px 14px;
    outline: none;
    transition: border-color 0.2s;
    min-width: 140px;
  }
  .field input:focus, .field select:focus { border-color: var(--gold); }
  .field select option { background: var(--surface2); }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 16px;
  }
  thead th {
    text-align: left;
    padding: 12px 16px;
    font-size: 11px;
    letter-spacing: 3px;
    text-transform: uppercase;
    color: var(--gold);
    border-bottom: 1px solid var(--border);
    font-weight: 500;
  }
  tbody tr {
    border-bottom: 1px solid rgba(201,148,58,0.08);
    transition: background 0.2s;
  }
  tbody tr:hover { background: rgba(201,148,58,0.04); }
  tbody td {
    padding: 14px 16px;
    color: var(--cream-dim);
  }
  tbody td:first-child { color: var(--cream); }
  .rank-1 td:first-child { color: var(--gold-light); }
  .rank-gold { color: var(--gold-light) !important; font-weight: 600; }

  .rank-badge {
    display: inline-block;
    width: 28px; height: 28px;
    line-height: 28px;
    text-align: center;
    border-radius: 50%;
    font-size: 13px;
    font-weight: 600;
    margin-right: 8px;
  }
  .rank-badge.r1 { background: rgba(201,148,58,0.2); color: var(--gold-light); border: 1px solid var(--gold); }
  .rank-badge.r2 { background: rgba(160,144,112,0.2); color: #b8a880; border: 1px solid #a09070; }
  .rank-badge.r3 { background: rgba(176,96,64,0.2); color: #d0a080; border: 1px solid #c07050; }

  .pulse-dot {
    display: inline-block;
    width: 8px; height: 8px;
    background: var(--amber);
    border-radius: 50%;
    margin-right: 8px;
    animation: pulse 1s ease-in-out infinite;
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.4; transform: scale(0.7); }
  }

  .metronome-beat {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin: 16px 0;
  }
  .beat-dot {
    width: 12px; height: 12px;
    border-radius: 50%;
    background: var(--surface2);
    border: 1px solid var(--border);
    transition: all 0.05s;
  }
  .beat-dot.active {
    background: var(--amber);
    box-shadow: 0 0 12px rgba(224,112,32,0.8);
    border-color: var(--amber);
  }
  .beat-dot.akshara {
    width: 16px; height: 16px;
    border-color: var(--gold-dim);
  }
  .beat-dot.akshara.active {
    background: var(--gold);
    box-shadow: 0 0 16px rgba(201,148,58,0.9);
  }

  .tags {
    display: flex; gap: 8px; flex-wrap: wrap; margin-top: 16px;
  }
  .tag {
    padding: 4px 12px;
    border: 1px solid var(--border);
    font-size: 12px;
    letter-spacing: 1px;
    color: var(--cream-dim);
    border-radius: 1px;
  }

  .info-text {
    color: var(--cream-dim);
    font-style: italic;
    font-size: 16px;
    margin-top: 8px;
  }

  .two-col {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
  }
  @media (max-width: 600px) { .two-col { grid-template-columns: 1fr; } }

  /* ORNAMENTAL DIVIDER */
  .divider {
    text-align: center;
    color: var(--gold-dim);
    font-size: 12px;
    letter-spacing: 8px;
    margin: 8px 0 20px;
  }

  .status-bar {
    display: flex; align-items: center; gap: 16px;
    padding: 12px 16px;
    background: rgba(201,148,58,0.06);
    border: 1px solid var(--border);
    border-radius: 1px;
    margin-top: 16px;
    font-size: 14px;
    color: var(--cream-dim);
  }
  .status-on { color: var(--gold-light); }

  select {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--cream);
    font-family: var(--font-body);
    font-size: 16px;
    padding: 10px 14px;
    outline: none;
    cursor: pointer;
  }

  .btn-row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
</style>
</head>
<body>

<header>
  <div class="header-ornament">Carnatic Practice Companion</div>
  <h1>Svara</h1>
  <p class="subtitle">‡§∏‡•ç‡§µ‡§∞ ‚Äî Cultivate your voice, sharpen your rhythm</p>
</header>

<nav>
  <button class="active" onclick="switchTab('shruti')">üéµ Shruti & Tanpura</button>
  <button onclick="switchTab('varisai')">‚è± Varisai Drills</button>

</nav>

<main>
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       TAB 1: SHRUTI & TANPURA
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="tab-shruti" class="tab-panel active">

    <div class="card">
      <div class="card-title">Shruti Selection</div>
      <p class="info-text">Select your base pitch (Sa). The tanpura and swarasthanam will update accordingly.</p>
      <div class="shruti-grid" id="shrutiGrid"></div>
      <div class="status-bar">
        <span>Selected Sa:</span>
        <span class="status-on" id="shrutiStatus">C</span>
      </div>
    </div>

    <div class="card">
      <div class="card-title">Practice Swarasthanam</div>
      <p class="info-text">Click any swaram to hear it against your selected Sa. Use this to tune your voice or instrument.</p>
      <div id="swaraGrid" style="margin-top:20px;"></div>
      <div class="status-bar" style="margin-top:16px;">
        <span>Playing:</span>
        <span class="status-on" id="swaraStatus">‚Äî</span>
      </div>
    </div>

    <div class="card">
      <div class="card-title">Tanpura Drone</div>
      <p class="info-text">Continuous Sa‚ÄìPa drone in the lower octave. Sit with it and let your ear find the centre.</p>

      <div class="tanpura-visual" id="tanpuraVisual"></div>

      <div class="divider">‚ú¶ ‚ú¶ ‚ú¶</div>

      <div class="field" style="max-width:320px;">
        <label>Volume</label>
        <input type="range" id="volumeSlider" min="0" max="100" value="70" oninput="updateDroneVolume(this.value)">
      </div>

      <div class="btn-row" style="margin-top:20px;">
        <button class="btn primary" id="tanpuraBtn" onclick="toggleTanpura()">‚ñ∂ Start Tanpura</button>
        <div id="tanpuraStatus" style="font-size:14px; color:var(--cream-dim); font-style:italic;"></div>
      </div>
    </div>

  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       TAB 2: VARISAI DRILLS
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div id="tab-varisai" class="tab-panel">

    <div class="card">
      <div class="card-title">Select Raga</div>
      <p class="info-text" style="margin-bottom:18px;">Choose a raga ‚Äî this sets the exact swarasthana pitches for all exercises.</p>
      <div id="ragaGrid" style="display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:10px;"></div>
      <div class="status-bar" style="margin-top:16px;">
        <span>Selected:</span>
        <span class="status-on" id="ragaStatus">Mayamalavagowlai</span>
        <span style="margin-left:auto; font-size:12px; color:var(--cream-dim); font-style:italic;" id="ragaScale"></span>
      </div>
    </div>

    <div class="card">
      <div class="card-title">Select Exercise</div>
      <div class="varisai-list" id="varisaiList"></div>
    </div>

    <div class="card">
      <div class="card-title">Metronome & Timer</div>

      <div style="margin-bottom:20px;">
        <div style="font-size:12px; letter-spacing:2px; text-transform:uppercase; color:var(--cream-dim); margin-bottom:10px;">Sequence ‚Äî Adi Tala</div>
        <div id="noteDisplay" style="overflow-x:auto; white-space:nowrap; padding:4px 0 10px; min-height:44px;"></div>
      </div>

      <div style="margin-bottom:24px;">
        <label style="font-size:12px; letter-spacing:2px; text-transform:uppercase; color:var(--cream-dim);">Tempo (BPM)</label>
        <div style="display:flex; align-items:center; gap:20px; margin-top:8px; flex-wrap:wrap;">
          <div>
            <div class="tempo-display" id="tempoDisplay">80</div>
            <div class="tempo-unit">beats / min</div>
          </div>
          <div style="flex:1; min-width:180px;">
            <input type="range" id="tempoSlider" min="40" max="600" value="80" oninput="updateTempo(this.value)">
            <div style="display:flex; justify-content:space-between; font-size:12px; color:var(--cream-dim);">
              <span>40</span><span>Vilamba</span><span>Madhyama</span><span>Druta</span><span>600</span>
            </div>
          </div>
          <div>
            <div class="metronome-beat" id="beatVisual" style="justify-content:flex-start;"></div>
            <div style="font-size:11px; color:var(--cream-dim); text-align:center; margin-top:4px; letter-spacing:1px;">Adi Tala</div>
          </div>
        </div>
      </div>

      <div style="margin-top:8px;">
        <label style="font-size:12px; letter-spacing:2px; text-transform:uppercase; color:var(--cream-dim);">Practice Timer</label>
        <div class="timer-display" id="timerDisplay">05:00</div>
        <div class="timer-progress"><div class="timer-progress-fill" id="timerFill"></div></div>
        <div style="display:flex; gap:12px; margin-bottom:16px;">
          <label style="font-size:12px; letter-spacing:1px; color:var(--cream-dim);">Duration:</label>
          <select id="durationSelect" style="font-size:14px; padding:4px 10px;">
            <option value="60">1 min</option>
            <option value="120">2 min</option>
            <option value="300" selected>5 min</option>
            <option value="600">10 min</option>
          </select>
        </div>
        <div class="btn-row">
          <button class="btn primary" id="metronomeBtn" onclick="toggleMetronome()">‚ñ∂ Start</button>
          <button class="btn" onclick="resetTimer()">‚Ü∫ Reset</button>
          <div id="drillStatus" style="font-size:14px; color:var(--cream-dim); font-style:italic; margin-left:8px;"></div>
        </div>
      </div>
    </div>

  </div>


</main>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TAB NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchTab(id) {
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + id).classList.add('active');
  event.target.classList.add('active');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUDIO CONTEXT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let audioCtx = null;
function getAudioCtx() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if (audioCtx.state === 'suspended') audioCtx.resume();
  return audioCtx;
}

// ‚îÄ‚îÄ‚îÄ Frequencies: two octaves to cover tanpura (low) and swarams (mid) ‚îÄ‚îÄ‚îÄ
// Low octave (C2‚ÄìB2) for tanpura drone
const LOW_FREQS = {
  'C':  65.41, 'C#': 69.30, 'D':  73.42, 'D#': 77.78,
  'E':  82.41, 'F':  87.31, 'F#': 92.50, 'G':  98.00,
  'G#':103.83, 'A': 110.00, 'A#':116.54, 'B': 123.47
};
// Mid octave (C3‚ÄìB3) for swarams
const MID_FREQS = {
  'C': 130.81, 'C#':138.59, 'D': 146.83, 'D#':155.56,
  'E': 164.81, 'F': 174.61, 'F#':185.00, 'G': 196.00,
  'G#':207.65, 'A': 220.00, 'A#':233.08, 'B': 246.94
};

// All 12 chromatic pitches for shruti selection
const WESTERN_PITCHES = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
const DISPLAY_NAMES    = ['C', 'C#','D', 'D#','E', 'F', 'F#','G', 'G#','A', 'A#','B'];

let selectedPitch = 'C'; // tonic as letter name

// Build shruti grid ‚Äî western pitch names only
const shrutiGrid = document.getElementById('shrutiGrid');
WESTERN_PITCHES.forEach((p, i) => {
  const btn = document.createElement('button');
  btn.className = 'shruti-btn' + (i === 0 ? ' selected' : '');
  btn.innerHTML = `<div style="font-size:16px;font-weight:600">${DISPLAY_NAMES[i]}</div>`;
  btn.onclick = () => {
    document.querySelectorAll('.shruti-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    selectedPitch = p;
    document.getElementById('shrutiStatus').textContent = DISPLAY_NAMES[i];
    // Preview Sa
    playNote(MID_FREQS[p], 0.8, 1.5);
    buildSwaraGrid();
    if (tanpuraPlaying) { stopTanpura(); setTimeout(startTanpura, 200); }
  };
  shrutiGrid.appendChild(btn);
});

// ‚îÄ‚îÄ‚îÄ SWARASTHANAM ‚îÄ‚îÄ‚îÄ
// Mapping (example root = C):
// semi 0  = Sa       (C)
// semi 1  = R1       (C#)
// semi 2  = R2 / G1  (D)
// semi 3  = R3 / G2  (D#)
// semi 4  = G3       (E)
// semi 5  = M1       (F)
// semi 6  = M2       (F#)
// semi 7  = Pa       (G)
// semi 8  = D1       (G#)
// semi 9  = D2 / N1  (A)
// semi 10 = N2 / D3  (A#)
// semi 11 = N3       (B)
// semi 12 = Sa‚Üë      (C)
const SWARA_GRID = [
  { name: 'Sa',         line2: '',        semi: 0,  accent: true  },
  { name: 'R1',         line2: '',        semi: 1                 },
  { name: 'R2',         line2: 'G1',      semi: 2                 },
  { name: 'R3',         line2: 'G2',      semi: 3                 },
  { name: 'G3',         line2: '',        semi: 4                 },
  { name: 'M1',         line2: '',        semi: 5                 },
  { name: 'M2',         line2: '',        semi: 6                 },
  { name: 'Pa',         line2: '',        semi: 7,  accent: true  },
  { name: 'D1',         line2: '',        semi: 8                 },
  { name: 'D2',         line2: 'N1',      semi: 9                 },
  { name: 'N2',         line2: 'D3',      semi: 10                },
  { name: 'N3',         line2: '',        semi: 11                },
  { name: 'Sa‚Üë',        line2: '',        semi: 12, accent: true  },
];

function semitoneFreq(baseFreq, semis) {
  return baseFreq * Math.pow(2, semis / 12);
}

function buildSwaraGrid() {
  const container = document.getElementById('swaraGrid');
  container.innerHTML = '';

  const grid = document.createElement('div');
  grid.style.cssText = 'display:grid; grid-template-columns: repeat(auto-fill, minmax(110px,1fr)); gap:10px;';

  const baseFreq = MID_FREQS[selectedPitch];

  SWARA_GRID.forEach(sw => {
    const btn = document.createElement('button');
    const isAccent = sw.accent;
    btn.style.cssText = `
      background: ${isAccent ? 'rgba(201,148,58,0.12)' : 'var(--surface2)'};
      border: 1px solid ${isAccent ? 'var(--gold)' : 'var(--border)'};
      color: var(--cream);
      font-family: var(--font-body);
      padding: 14px 10px;
      cursor: pointer;
      transition: all 0.2s;
      border-radius: 1px;
      text-align: center;
    `;

    const freq = semitoneFreq(baseFreq, sw.semi);
    const western = freqToWestern(selectedPitch, sw.semi);

    btn.innerHTML = `
      <div style="font-size:17px; font-weight:600; color:${isAccent ? 'var(--gold-light)' : 'var(--cream)'};">${sw.name}</div>
      ${sw.line2 ? `<div style="font-size:12px; color:var(--gold-dim); margin-top:3px; letter-spacing:1px;">${sw.line2}</div>` : `<div style="font-size:12px; margin-top:3px;">&nbsp;</div>`}
      <div style="font-size:11px; color:var(--cream-dim); margin-top:4px; letter-spacing:1px;">${western}</div>
    `;

    btn.onmouseover = () => { btn.style.borderColor = 'var(--gold)'; btn.style.background = isAccent ? 'rgba(201,148,58,0.22)' : 'rgba(201,148,58,0.08)'; };
    btn.onmouseout  = () => { btn.style.borderColor = isAccent ? 'var(--gold)' : 'var(--border)'; btn.style.background = isAccent ? 'rgba(201,148,58,0.12)' : 'var(--surface2)'; };

    btn.onclick = () => {
      playNote(freq, 0.9, 2.5);
      const label = sw.line2 ? `${sw.name} / ${sw.line2}` : sw.name;
      document.getElementById('swaraStatus').textContent = `${label} ‚Äî ${western} (${Math.round(freq)} Hz)`;
    };

    grid.appendChild(btn);
  });

  container.appendChild(grid);
}

function freqToWestern(rootPitch, semis) {
  const chromatic = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
  const rootIdx = chromatic.indexOf(rootPitch);
  const noteIdx = (rootIdx + semis) % 12;
  const octaveUp = semis >= 12;
  return chromatic[noteIdx] + (octaveUp ? '‚Üë' : '');
}

buildSwaraGrid();


// ‚îÄ‚îÄ‚îÄ CONSTANT TANPURA DRONE ‚îÄ‚îÄ‚îÄ
// We hold four persistent oscillator stacks (Sa low, Pa, Sa mid, Sa mid)
// Each stack has layered harmonics. All nodes kept alive until stopTanpura().
let droneNodes = []; // array of {oscs, gainNode} per string
let droneGainMaster = null;
let tanpuraPlaying = false;

// The four drone pitches: Sa, Pa (3/2), Sa octave up (√ó2), Sa octave up (√ó2)
const DRONE_RATIOS = [
  { label: 'Sa',  ratio: 1   },
  { label: 'Pa',  ratio: 3/2 },
  { label: 'Sa‚Üë', ratio: 2   },
  { label: 'Sa‚Üë', ratio: 2   },
];

function buildTanpuraVisual() {
  const vis = document.getElementById('tanpuraVisual');
  vis.innerHTML = '';
  DRONE_RATIOS.forEach((s, i) => {
    const wrap = document.createElement('div');
    wrap.className = 'string-wrap';
    const str = document.createElement('div');
    str.className = 'string';
    str.id = 'string-' + i;
    str.style.height = [110, 90, 90, 70][i] + 'px';
    const lbl = document.createElement('div');
    lbl.className = 'string-label';
    lbl.textContent = s.label;
    wrap.appendChild(str);
    wrap.appendChild(lbl);
    vis.appendChild(wrap);
  });
}
buildTanpuraVisual();

function pluckString(i) {} // no-op for drone mode

function playNote(freq, vol, dur) {
  const ctx = getAudioCtx();
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  osc.connect(gain); gain.connect(ctx.destination);
  osc.type = 'triangle';
  osc.frequency.setValueAtTime(freq, ctx.currentTime);
  gain.gain.setValueAtTime(vol * 0.3, ctx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + dur);
  osc.start(); osc.stop(ctx.currentTime + dur);
}

function startTanpura() {
  const ctx = getAudioCtx();
  const vol = parseFloat(document.getElementById('volumeSlider').value) / 100;

  // Master gain for volume control
  droneGainMaster = ctx.createGain();
  droneGainMaster.gain.setValueAtTime(0, ctx.currentTime);
  droneGainMaster.gain.linearRampToValueAtTime(vol, ctx.currentTime + 1.2); // gentle fade-in
  droneGainMaster.connect(ctx.destination);

  droneNodes = [];
  DRONE_RATIOS.forEach((s, i) => {
    const freq = LOW_FREQS[selectedPitch] * s.ratio;
    const stringOscs = [];
    // Layered harmonics: fundamental + 2nd + 3rd + 4th + slight detuned pair
    const harmonics = [
      { mult: 1,    vol: 0.22 },
      { mult: 2,    vol: 0.10 },
      { mult: 3,    vol: 0.06 },
      { mult: 4,    vol: 0.03 },
      { mult: 1,    vol: 0.04, detune: 3  }, // slight chorus
      { mult: 1,    vol: 0.04, detune: -3 },
    ];
    harmonics.forEach(h => {
      const osc = ctx.createOscillator();
      const g = ctx.createGain();
      osc.type = 'sine';
      osc.frequency.value = freq * h.mult;
      if (h.detune) osc.detune.value = h.detune;
      g.gain.value = h.vol / DRONE_RATIOS.length;
      osc.connect(g);
      g.connect(droneGainMaster);
      osc.start();
      stringOscs.push({ osc, g });
    });
    droneNodes.push(stringOscs);

    // Ambient string glow
    const el = document.getElementById('string-' + i);
    if (el) el.style.boxShadow = '0 0 10px 3px rgba(224,112,32,0.5)';
  });

  tanpuraPlaying = true;
  document.getElementById('tanpuraBtn').textContent = '‚ñ† Stop Tanpura';
  document.getElementById('tanpuraStatus').innerHTML = '<span class="pulse-dot"></span>Drone active';
}

function stopTanpura() {
  if (!tanpuraPlaying) return;
  const ctx = getAudioCtx();

  // Gentle fade-out
  if (droneGainMaster) {
    droneGainMaster.gain.setValueAtTime(droneGainMaster.gain.value, ctx.currentTime);
    droneGainMaster.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.8);
  }
  setTimeout(() => {
    droneNodes.forEach(stringOscs => {
      stringOscs.forEach(({ osc }) => { try { osc.stop(); } catch(e) {} });
    });
    droneNodes = [];
    droneGainMaster = null;
  }, 900);

  // Clear string glow
  DRONE_RATIOS.forEach((_, i) => {
    const el = document.getElementById('string-' + i);
    if (el) el.style.boxShadow = '';
  });

  tanpuraPlaying = false;
  document.getElementById('tanpuraBtn').textContent = '‚ñ∂ Start Tanpura';
  document.getElementById('tanpuraStatus').textContent = '';
}

function toggleTanpura() {
  if (tanpuraPlaying) stopTanpura();
  else startTanpura();
}

function updateDroneVolume(val) {
  const vol = parseInt(val) / 100;
  if (droneGainMaster) {
    droneGainMaster.gain.setValueAtTime(vol, getAudioCtx().currentTime);
  }
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VARISAI DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RAGAS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Each raga maps swaram names to semitone offsets from Sa
// s/S = lower/upper Sa, r/R=Ri, g/G=Ga, m/M=Ma, p/P=Pa, d/D=Da, n/N=Ni
// We store per-raga semitone for each scale degree position

const RAGAS = [
  {
    name: 'Mayamalavagowlai',
    short: 'MMG',
    scale: 'S R1 G3 M1 P D1 N3',
    semi: { s:0, r:1,  g:4,  m:5,  p:7, d:8,  n:11, S:12 }
  },
  {
    name: 'Kharaharapriya',
    short: 'KHP',
    scale: 'S R2 G2 M1 P D2 N2',
    semi: { s:0, r:2,  g:3,  m:5,  p:7, d:9,  n:10, S:12 }
  },
  {
    name: 'Shankarabharnam',
    short: 'SNB',
    scale: 'S R2 G3 M1 P D2 N3',
    semi: { s:0, r:2,  g:4,  m:5,  p:7, d:9,  n:11, S:12 }
  },
  {
    name: 'Kalyani',
    short: 'KLY',
    scale: 'S R2 G3 M2 P D2 N3',
    semi: { s:0, r:2,  g:4,  m:6,  p:7, d:9,  n:11, S:12 }
  },
];

let selectedRaga = 0;

const ragaGrid = document.getElementById('ragaGrid');
RAGAS.forEach((raga, i) => {
  const btn = document.createElement('div');
  btn.className = 'varisai-item' + (i === 0 ? ' selected' : '');
  btn.innerHTML = `
    <div style="font-size:15px; font-weight:600; color:var(--cream);">${raga.name}</div>
    <div style="font-size:12px; color:var(--cream-dim); margin-top:4px; letter-spacing:1px;">${raga.scale}</div>
  `;
  btn.onclick = () => {
    document.querySelectorAll('#ragaGrid .varisai-item').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    selectedRaga = i;
    document.getElementById('ragaStatus').textContent = raga.name;
    document.getElementById('ragaScale').textContent = raga.scale;
    if (metronomeRunning) { stopMetronome(); startMetronome(); }
  };
  ragaGrid.appendChild(btn);
});
document.getElementById('ragaScale').textContent = RAGAS[0].scale;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXERCISES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Notes use lowercase letters: s r g m p d n = Sa Ri Ga Ma Pa Da Ni (mid octave)
// Uppercase S = upper Sa (semi 12)
// Each note plays one beat of Adi tala

const VARISAIS = [
  {
    name: 'Sarali Varisai 1',
    notes: ['s','r','g','m','p','d','n','S',  'S','n','d','p','m','g','r','s'],
  },
  {
    name: 'Janta Varisai 1',
    notes: ['s','s','r','r','g','g','m','m',  'p','p','d','d','n','n','S','S',
            'S','S','n','n','d','d','p','p',  'm','m','g','g','r','r','s','s'],
  },
  {
    name: 'Janta Varisai 2',
    // s s r r | g g | m m || r r g g | m m | p p || g g m m | p p | d d || m m p p | d d | n n ||
    // p p d d | n n | S S || S S n n | d d | p p || n n d d | p p | m m || d d p p | m m | g g ||
    // p p m m | g g | r r || m m g g | r r | s s ||
    notes: [
      's','s','r','r','g','g','m','m',  'r','r','g','g','m','m','p','p',
      'g','g','m','m','p','p','d','d',  'm','m','p','p','d','d','n','n',
      'p','p','d','d','n','n','S','S',  'S','S','n','n','d','d','p','p',
      'n','n','d','d','p','p','m','m',  'd','d','p','p','m','m','g','g',
      'p','p','m','m','g','g','r','r',  'm','m','g','g','r','r','s','s',
    ],
  },
  {
    name: 'Janta Varisai 3',
    // Ascending with bounce pattern: s s r s | s r | s r || s s r r | g g | m m || r r g r | r g | r g || r r g g | m m | p p || ...
    notes: [
      // avartana 1
      's','s','r','s', 's','r','s','r',  's','s','r','r','g','g','m','m',
      'r','r','g','r', 'r','g','r','g',  'r','r','g','g','m','m','p','p',
      'g','g','m','g', 'g','m','g','m',  'g','g','m','m','p','p','d','d',
      'm','m','p','m', 'm','p','m','p',  'm','m','p','p','d','d','n','n',
      'p','p','d','p', 'p','d','p','d',  'p','p','d','d','n','n','S','S',
      // avartana 2 (descending)
      'S','S','n','S', 'S','n','S','n',  'S','S','n','n','d','d','p','p',
      'n','n','d','n', 'n','d','n','d',  'n','n','d','d','p','p','m','m',
      'd','d','p','d', 'd','p','d','p',  'd','d','p','p','m','m','g','g',
      'p','p','m','p', 'p','m','p','m',  'p','p','m','m','g','g','r','r',
      'm','m','g','m', 'm','g','m','g',  'm','m','g','g','r','r','s','s',
    ],
  },
  {
    name: 'Dhatu Varisai 1',
    // s m g m | r g | s r || s g r g | s r | g m || r p m p | g m | r g || r m g m | r g | m p ||
    // g d p d | m p | g m || g p m p | g m | p d || m n d n | p d | m p || m d p d | m p | d n ||
    // p S n S | d n | p d || p n d n | p d | n S ||
    // S p d p | n d | S n || S d n d | S n | d p || n m p m | d p | n d || n p d p | n d | p m ||
    // d g m g | p m | d p || d m p m | d p | m g || p r g r | m g | p m || p g m g | p m | g r ||
    // m s r s | g r | m g || m r g r | m g | r s ||
    notes: [
      's','m','g','m','r','g','s','r',  's','g','r','g','s','r','g','m',
      'r','p','m','p','g','m','r','g',  'r','m','g','m','r','g','m','p',
      'g','d','p','d','m','p','g','m',  'g','p','m','p','g','m','p','d',
      'm','n','d','n','p','d','m','p',  'm','d','p','d','m','p','d','n',
      'p','S','n','S','d','n','p','d',  'p','n','d','n','p','d','n','S',
      'S','p','d','p','n','d','S','n',  'S','d','n','d','S','n','d','p',
      'n','m','p','m','d','p','n','d',  'n','p','d','p','n','d','p','m',
      'd','g','m','g','p','m','d','p',  'd','m','p','m','d','p','m','g',
      'p','r','g','r','m','g','p','m',  'p','g','m','g','p','m','g','r',
      'm','s','r','s','g','r','m','g',  'm','r','g','r','m','g','r','s',
    ],
  },
  {
    name: 'Dhatu Varisai 2',
    // s r s g | r g | r m || s m g r | s r | g m || r g r m | g m | g p || r p m g | r g | m p ||
    // g m g p | m p | m d || g d p m | g m | p d || m p m d | p d | p n || m n d p | m p | d n ||
    // p d p n | d n | d S || p S n d | p d | n S || S n S d | n d | n p || S p d n | S n | d p ||
    // n d n p | d p | d m || n m p d | n d | p m || d p d m | p m | p g || d g m p | d p | m g ||
    // p m p g | m g | m r || p r g m | p m | g r || m g m r | g r | g s || m s r g | m g | r s ||
    notes: [
      's','r','s','g','r','g','r','m',  's','m','g','r','s','r','g','m',
      'r','g','r','m','g','m','g','p',  'r','p','m','g','r','g','m','p',
      'g','m','g','p','m','p','m','d',  'g','d','p','m','g','m','p','d',
      'm','p','m','d','p','d','p','n',  'm','n','d','p','m','p','d','n',
      'p','d','p','n','d','n','d','S',  'p','S','n','d','p','d','n','S',
      'S','n','S','d','n','d','n','p',  'S','p','d','n','S','n','d','p',
      'n','d','n','p','d','p','d','m',  'n','m','p','d','n','d','p','m',
      'd','p','d','m','p','m','p','g',  'd','g','m','p','d','p','m','g',
      'p','m','p','g','m','g','m','r',  'p','r','g','m','p','m','g','r',
      'm','g','m','r','g','r','g','s',  'm','s','r','g','m','g','r','s',
    ],
  },
  {
    name: 'Eka Talam Alankaram',
    // SRGM RGMP GMPD MPDN PDNS  SNDP NDPM DPMG PMGR MGRS
    // Each group of 4 = one beat of eka talam, but we play each note as one unit
    notes: [
      's','r','g','m',  'r','g','m','p',  'g','m','p','d',  'm','p','d','n',  'p','d','n','S',
      'S','n','d','p',  'n','d','p','m',  'd','p','m','g',  'p','m','g','r',  'm','g','r','s',
    ],
  },
];

let selectedVarisai = 0;
let drillNoteIdx = 0;

const varisaiList = document.getElementById('varisaiList');
VARISAIS.forEach((v, i) => {
  const el = document.createElement('div');
  el.className = 'varisai-item' + (i === 0 ? ' selected' : '');
  el.innerHTML = `<div class="varisai-name">${v.name}</div><div style="font-size:12px;color:var(--cream-dim);margin-top:3px;letter-spacing:1px;">${v.notes.slice(0,8).map(n=>n.toUpperCase()).join(' ¬∑ ')}${v.notes.length>8?' ‚Ä¶':''}</div>`;
  el.onclick = () => {
    document.querySelectorAll('#varisaiList .varisai-item').forEach(x => x.classList.remove('selected'));
    el.classList.add('selected');
    selectedVarisai = i;
    drillNoteIdx = 0;
    buildNoteDisplay();
    if (metronomeRunning) { stopMetronome(); startMetronome(); }
  };
  varisaiList.appendChild(el);
});

function buildNoteDisplay() {
  const v = VARISAIS[selectedVarisai];
  const container = document.getElementById('noteDisplay');
  if (!container) return;
  // Group into avartanas of 8 for Adi tala visual grouping, with dividers
  let html = '';
  v.notes.forEach((n, i) => {
    if (i > 0 && i % 8 === 0) html += `<span style="display:inline-block;width:8px;"></span><span style="display:inline-block;width:1px;height:28px;background:var(--border);vertical-align:middle;margin:0 4px;"></span>`;
    html += `<span id="nd-${i}" style="
      display:inline-block; padding:5px 9px; margin:2px;
      border:1px solid var(--border); border-radius:1px;
      font-family:var(--font-body); font-size:15px; font-weight:500;
      color:var(--cream-dim); background:var(--surface2);
      transition:all 0.12s; letter-spacing:0.5px;
    ">${n === 'S' ? '·π†' : n.toUpperCase()}</span>`;
  });
  container.innerHTML = html;
}

function highlightNote(idx) {
  const v = VARISAIS[selectedVarisai];
  v.notes.forEach((_, i) => {
    const el = document.getElementById('nd-' + i);
    if (!el) return;
    el.style.color = 'var(--cream-dim)';
    el.style.background = 'var(--surface2)';
    el.style.borderColor = 'var(--border)';
    el.style.transform = 'scale(1)';
  });
  const cur = document.getElementById('nd-' + idx);
  if (cur) {
    cur.style.color = 'var(--gold-light)';
    cur.style.background = 'rgba(201,148,58,0.2)';
    cur.style.borderColor = 'var(--gold)';
    cur.style.transform = 'scale(1.1)';
    cur.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
  }
}

buildNoteDisplay();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// METRONOME & TIMER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let bpm = 80;
let metronomeRunning = false;
let metronomeTimeout = null;
let beatIdx = 0;
const beatsPerCycle = 8; // fixed Adi tala
let timerSeconds = 300;
let timerMax = 300;
let timerInterval = null;

function updateTempo(val) {
  bpm = parseInt(val);
  document.getElementById('tempoDisplay').textContent = bpm;
  if (metronomeRunning) { stopMetronome(); startMetronome(); }
}

function buildBeatDots() {
  const vis = document.getElementById('beatVisual');
  vis.innerHTML = '';
  for (let i = 0; i < beatsPerCycle; i++) {
    const d = document.createElement('div');
    d.className = 'beat-dot' + (i === 0 ? ' akshara' : '');
    d.id = 'beat-' + i;
    vis.appendChild(d);
  }
}
buildBeatDots();

function playClick(isAccent) {
  const ctx = getAudioCtx();
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  osc.connect(gain); gain.connect(ctx.destination);
  osc.frequency.value = isAccent ? 1000 : 700;
  osc.type = 'square';
  gain.gain.setValueAtTime(isAccent ? 0.05 : 0.025, ctx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.05);
  osc.start(); osc.stop(ctx.currentTime + 0.05);
}

function playDrillNote(noteIdx) {
  const v = VARISAIS[selectedVarisai];
  const noteName = v.notes[noteIdx % v.notes.length]; // 's','r','g','m','p','d','n','S'
  const raga = RAGAS[selectedRaga];
  const semi = raga.semi[noteName] ?? 0;
  const baseFreq = MID_FREQS[selectedPitch];
  const freq = baseFreq * Math.pow(2, semi / 12);

  const ctx = getAudioCtx();
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  osc.connect(gain); gain.connect(ctx.destination);
  osc.type = 'sine';
  osc.frequency.setValueAtTime(freq, ctx.currentTime);
  const noteDur = Math.min((60 / bpm) * 0.82, 0.55);
  gain.gain.setValueAtTime(0.7, ctx.currentTime);
  gain.gain.setValueAtTime(0.7, ctx.currentTime + noteDur * 0.55);
  gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + noteDur);
  osc.start(); osc.stop(ctx.currentTime + noteDur);
}

function tick() {
  if (!metronomeRunning) return;
  document.querySelectorAll('.beat-dot').forEach(d => d.classList.remove('active'));
  const dot = document.getElementById('beat-' + beatIdx);
  if (dot) dot.classList.add('active');
  playClick(beatIdx === 0);

  const v = VARISAIS[selectedVarisai];
  playDrillNote(drillNoteIdx);
  highlightNote(drillNoteIdx);
  drillNoteIdx = (drillNoteIdx + 1) % v.notes.length;
  beatIdx = (beatIdx + 1) % beatsPerCycle;

  metronomeTimeout = setTimeout(tick, (60 / bpm) * 1000);
}

function startMetronome() {
  metronomeRunning = true;
  beatIdx = 0;
  drillNoteIdx = 0;
  document.getElementById('metronomeBtn').textContent = '‚ñ† Stop';
  tick();
  const dur = parseInt(document.getElementById('durationSelect').value);
  timerMax = dur; timerSeconds = dur;
  updateTimerDisplay();
  timerInterval = setInterval(() => {
    timerSeconds--;
    updateTimerDisplay();
    if (timerSeconds <= 0) { stopMetronome(); document.getElementById('drillStatus').textContent = '‚ú¶ Session complete!'; }
  }, 1000);
}

function stopMetronome() {
  metronomeRunning = false;
  clearTimeout(metronomeTimeout);
  clearInterval(timerInterval);
  drillNoteIdx = 0;
  document.getElementById('metronomeBtn').textContent = '‚ñ∂ Start';
  document.querySelectorAll('.beat-dot').forEach(d => d.classList.remove('active'));
  const v = VARISAIS[selectedVarisai];
  v.notes.forEach((_, i) => {
    const el = document.getElementById('nd-' + i);
    if (!el) return;
    el.style.color = 'var(--cream-dim)';
    el.style.background = 'var(--surface2)';
    el.style.borderColor = 'var(--border)';
    el.style.transform = 'scale(1)';
  });
}

function toggleMetronome() {
  if (metronomeRunning) { stopMetronome(); document.getElementById('drillStatus').textContent = ''; }
  else { startMetronome(); document.getElementById('drillStatus').innerHTML = '<span class="pulse-dot"></span>Practice active'; }
}

function resetTimer() {
  stopMetronome();
  const dur = parseInt(document.getElementById('durationSelect').value);
  timerMax = dur; timerSeconds = dur;
  updateTimerDisplay();
  document.getElementById('drillStatus').textContent = '';
}

function updateTimerDisplay() {
  const m = Math.floor(timerSeconds / 60).toString().padStart(2, '0');
  const s = (timerSeconds % 60).toString().padStart(2, '0');
  document.getElementById('timerDisplay').textContent = m + ':' + s;
  const pct = ((timerMax - timerSeconds) / timerMax) * 100;
  document.getElementById('timerFill').style.width = pct + '%';
}

</script>
</body>
</html>
